<% include ../partials/header %>

<div class="container">
    <div class="d-flex justify-content-center">
        <!--<div class="col-lg-1"></div>-->
        <div class="col-lg-10 nopadding">
            <!-- INFO SECTION START -->
            <div class="card mb-3">
                <img class="card-img-top activity-show-image" src="<%= activity.image %>" alt="<%= activity.name %>">
                <div class="card-body">
                    <div class="d-flex flex-row flex-wrap justify-content-between">
                        <div class="d-flex flex-column align-items-start">
                            <h3 class="card-title mr-3">
                                <% if(activity.status === "current"){ %>
                                    <span class="tooltip-status" alt="<strong>Current Info</strong><br>This activity has been checked or updated in the last 6 months"><i class="fa fa-check-circle fa-1x text-success"></i><span class="tooltip-status-text"><strong>Current Info</strong><br>This activity has been checked or updated in the last 6 months</span></span>
                                <% } else if(activity.status === "review"){ %>
                                    <span class="tooltip-status" alt="<strong>Under Review</strong><br>This activity has not been checked or updated in the last 6 months. The information might be out of date."><i class="fa fa-question-circle fa-1x text-warning"></i><span class="tooltip-status-text"><strong>Under Review</strong><br>This activity has not been checked or updated in the last 6 months. The information might be out of date.</span></span>
                                <% } else { %>
                                    <span class="tooltip-status" alt="<strong>Out of Date</strong><br>This activity has been removed because it has already happened or has not been updated for over a year."><i class="fa fa-times-circle fa-1x text-danger"></i><span class="tooltip-status-text"><strong>Out of Date</strong><br>This activity has been removed because it has already happend or has not been updated for over a year.</span></span>
                                <% } %>
                                <%= activity.name %></h3>
                            <span>
                                <em><strong>Added by:</strong> <a href="/users/<%= activity.author._id %>"><%= activity.author.displayName %></a>, <%= moment(activity.createdAt).fromNow() %></em>
                            </span>
                            <span class="mb-2">
                                <em><strong>Last checked by:</strong> <a href="/users/<%= activity.author._id %>"><%= activity.author.displayName %></a>, <%= moment(activity.createdAt).fromNow() %></em>
                            </span>
                            <% if(currentUser && (activity.author._id.equals(currentUser._id) || currentUser.isAdmin)){ %>
                                <div class="d-flex flex-row mb-2">
                                    <a class="btn btn-sm btn-warning mr-2" href="/activities/<%= activity._id %>/edit">Edit</a>
                                    <form class="inline-form" action="/activities/<%= activity._id %>?_method=DELETE" method="POST">
                                        <button class="btn btn-sm btn-danger" disabled>Delete</button>
                                    </form>
                                </div>
                            <% } %>
                        </div>
                        <div id="showPageLoveAndComment" class="d-flex flex-row justify-content-center flex-md-grow-0 flex-grow-1 mb-2">
                            <div class="d-flex flex-column align-items-center mr-4">
                                <span>Loves</span>
                                    <span id="sociableLove" class="fa-stack fa-1x sociable-love">
                                        <i class="fas fa-heart fa-stack-2x heart-offset"></i>
                                        <span id="sociableLoveNum" class="fa-stack-1x <%= loveColorClass %>"><%= (activity.loves.length) %></span>
                                    </span>
                                </span>
                            </div>
                            <div class="d-flex flex-column align-items-center">
                                <span>Comments</span>
                                    <span id="sociableComment" class="fa-stack fa-1x sociable-comment" onclick="scrollToComments()">
                                        <i class="fas fa-comment fa-stack-2x comment-offset"></i>
                                        <span id="sociableCommentNum" class="fa-stack-1x text-white"><%= (activity.comments.length) %></span>
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <!--START OF ACTIVITY INFO CONTENT-->
                    <div>
                        <h4>Description</h4>
                        <p class="mr-2"><%= activity.description %></p>
                        <% if(activity.videoUrl) { %>
                            <div class="d-flex flex-row justify-content-center mb-3">
                                <iframe width="100%" height="400px" src="https://www.youtube-nocookie.com/embed/<%= activity.youtubeVideoId %>?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                            </div>
                            <hr>
                        <% } %>
                    </div>
                    
                    <div class="d-flex flex-row flex-wrap">
                        <div class="d-flex flex-column col-md-8 nopadding">
                            <div class="d-flex flex-row">
                                <div class="col-md-6 nopadding">
                                    <h4>Ages</h4>
                                    <p class="mr-3"><%= activity.age %></p>
                                </div>
                                <div class="col-md-6 nopadding">
                                    <h4>Suitable for</h4>
                                    <p class="mr-2"><%= activity.suitable %></p>
                                </div>
                            </div>
                            <div class="d-flex flex-row card-grey mr-md-2">
                                <div class="col-md-6 nopadding">
                                    <h4 class="mt-1">When</h4>
                                    <p class="mr-3"><%= activity.when %></p>
                                </div>
                                <div class="col-md-6 nopadding">
                                    <h4 class="mt-1">Cost</h4>
                                    <p class="mr-2"><%= activity.price %></p>
                                </div>
                            </div>
                            <div class="d-flex flex-row mt-2">
                                <div class="col-md-6 nopadding">
                                    <h4>Type</h4>
                                    <p class="mr-3"><%= activity.frequency %></p>
                                </div>
                                <div class="col-md-6 nopadding">
                                    <h4>Where</h4>
                                    <p class="mr-2"><%= activity.location %></p>
                                </div>
                            </div>
                            <div class="d-flex flex-row card-grey mr-md-2 mb-2">
                                <div class="col-md-6 nopadding">
                                    <h4 class="mt-1">Who to contact</h4>
                                    <% if(activity.contactEmail || activity.contactNum) { %>
                                        <p class="mr-3">
                                            <% if(activity.contactNum) { %>
                                                Telephone: <%= activity.contactNum %>
                                                <br>
                                            <% } %>
                                            <% if(activity.contactEmail) { %>
                                                Email: <a href="mailto:<%= activity.contactEmail %>asd"><%= activity.contactEmail %></a>
                                            <% } %>
                                        </p>
                                    <% } else { %>
                                        No contact information has<br>been added <i class="fas fa-phone-slash"></i>
                                    <% } %>
                                </div>
                                <div class="col-md-6 nopadding">
                                    <h4 class="mt-1">Tags</h4>
                                    <p class="mr-2"><%= activity.tags %></p>
                                </div>
                            </div>
                            
                            
                            <% if(activity.linkStatus.isLinkBroken && activity.linkStatus.errorMessage === "404") { %>
                                <div class="alert alert-warning mr-3" role="alert">
                                    <i class="fa fa-exclamation-circle"></i> Oops! It looks like the website for this activity has moved...
                                    <br><br>
                                    The activity might still be running, they could have just moved the page. 
                                    <br><br>
                                    If you have a second could you check for us and let us know if they have a new page for this activity or if we should remove it?
                                </div>
                            <% } else if(activity.linkStatus.isLinkBroken) { %>
                                <div class="alert alert-warning mr-3" role="alert">
                                    <i class="fa fa-exclamation-circle"></i> We've just checked the website for this activity and it might not be working right now.
                                    <br><br>
                                    This could be a temporary problem, but if it doesn't get fixed soon we'll automatically remove this activity. (Status Code: <%= activity.linkStatus.errorMessage %>)
                                </div>
                            <% } %>
                            <div class="d-flex flex-row flex-wrap mt-1">
                                <div class="d-flex flex-row flex-wrap nopadding justify-content-between align-items-center flex-grow-1">
                                    
                                    <div class="flex-grow-1 nopadding">
                                        <% if(activity.website) { %>
                                            <a class="btn btn-primary btn-block mb-2" href="<%= activity.website %>">Activity website</a>
                                        <% } else { %>
                                            <a class="btn btn-secondary btn-block mb-2 disabled">Activity website</a>
                                        <% } %>
                                    </div>
                                    
                                    <div class="d-flex flex-row justify-content-center flex-grow-1">
                                        <div class="nopadding">
                                            <% if(activity.twitter) { %>
                                                <a class="mb-2 mr-2" href="<%= activity.twitter %>"><i class="fab fa-twitter fa-2x fa-fw" title="Activity Twitter Link"></i></a>
                                            <% } else { %>
                                                <a class="mb-2 mr-2 disabled text-secondary"><i class="fab fa-twitter fa-2x fa-fw" title="Activity Twitter Link"></i></a>
                                            <% } %>
                                        </div>
                                        <div class="nopadding">
                                            <% if(activity.facebook) { %>
                                                <a class="mb-2 ml-2" href="<%= activity.facebook %>"><i class="fab fa-facebook-square fa-2x fa-fw" title="Activity Facebook Link"></i></a>
                                            <% } else { %>
                                                <a class="mb-2 ml-2 disabled text-secondary"><i class="fab fa-facebook-square fa-2x fa-fw" title="Activity Facebook Link"></i></a>
                                            <% } %>
                                        </div>
                                    </div>
                                    
                                </div>
                                
                                <div class="flex-grow-1 nopadding mr-md-2">
                                    <a class="btn btn-warning btn-block mb-2" href="/contact"><strong>Something not right?</strong></a>
                                </div>
                                
                            </div>
                        </div>
                        
                        <div class="d-flex flex-column nopadding col-md-4 mb-2">
                            <div class="nopadding">
                                <a class="btn btn-success btn-block mb-1" href="http://maps.google.co.uk/?hl=en&saddr=&daddr=<%= activity.location %>">Get Directions <i class="fas fa-map-marker-alt"></i></a>
                            </div>
                            <div id="activity-show-map" style="border-radius: 5px;" class="flex-grow-1"></div>
                        </div>
                        
                    </div>
                    <!--END OF ACTIVITY INFO CONTENT-->
                </div>
            </div>
            <!-- INFO SECTION END -->

            <!-- COMMENT SECTION START -->
            <div id="commentSection" class="card mb-5">
                <div class="card-body">
                    <div class="float-left">
                        <h3>Comments</h3>
                    </div>
                    
                    <div class="text-right">
                        <a id="addCommentBtn" class="btn btn-success" role="button" data-toggle="collapse" href="#collapseComment" aria-expanded="false" aria-controls="collapseComment"><i class="fa fa-plus"></i> Add comment</a>
                    </div>
                    <hr>
                    
                    <!--Collapse Add a comment form START-->
                    <div class="collapse" id="collapseComment">
                        <div class="card mb-2">
                            <% if(!currentUser) { %>
                                <!--If the user is not logged in, direct them to the login page-->
                                <div class="card-body card-grey">
                                    <p class="card-text"><strong>You need to login before you can comment. Please <a id="commentLogin" href="/login">login</a> or <a id="commentRegister" href="/register">sign up (it's free!)</a></strong></p>
                                </div>
                            <% } %>
                            <% if(currentUser) { %>
                                <!--If the user is logged in, show the new comment form-->
                                <div class="card-body card-grey comment-card-current-user">
                                    <div class="card-title d-flex flex-row flex-wrap align-items-center justify-content-between">
                                        <div class="d-flex flex-row flex-wrap align-items-baseline justify-content-between">
                                            <strong>
                                                <a class="mr-1" href="/users/<%= currentUser._id %>">
                                                    <img class="" height="40" width="40" src="<%= process.env.CLOUDINARY_URL_START %>c_fill,h_100,w_100,f_auto,q_auto,r_max<%= currentUser.avatar.slice(46) %>" alt="Current User avatar">
                                                    <%= currentUser.displayName %>
                                                </a>
                                            </strong>
                                            <% if(currentUser.isMod) { %>
                                                <div class="d-flex flex-row flex-grow-1 justify-content-end align-items-center">
                                                    <i class="fas fa-crown text-warning mr-1"></i> <strong>Moderator</strong>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                    <form id="add-comment-form" action="/activities/<%= activity._id %>/comments" method="POST">
                                        <div class="form-group">
                                            <textarea id="addCommentInput" class="form-control" name="comment[text]" placeholder="Write your comment..." form="add-comment-form" rows="5" cols="70" required></textarea>
                                        </div>
                                        <div class="form-group d-flex flex-row flex-wrap flex-grow-1 justify-content-end align-items-start mb-0">
                                            <div id="commentErrorDiv" class="alert mb-0 pt-1 pb-1 mb-1 mr-1" role="alert"></div>
                                            <div>
                                                <button id="postNewCommentBtn" class="btn btn-primary">Post Comment</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            <% } %>
                        </div>
                    </div>
                    <!--Collapse Add a comment form END-->
                    
                    <!--Display all comments START-->
                    <div class="row">
                        <% activity.comments.forEach(function(comment){ %>
                            <div class="col-md-12 mb-2">
                                <div class="card">
                                    <div class="card-body card-grey <% if(currentUser && comment.author._id.equals(currentUser._id)){ %> comment-card-current-user <% } %>">
                                        <div class="card-title d-flex flex-row flex-wrap align-items-center justify-content-between">
                                            <div class="d-flex flex-row flex-wrap align-items-baseline">
                                                <strong>
                                                    <a class="mr-1" href="/users/<%= comment.author._id %>">
                                                        <img class="" height="40" width="40" src="<%= process.env.CLOUDINARY_URL_START %>c_fill,h_100,w_100,f_auto,q_auto,r_max<%= comment.author.avatar.slice(46) %>" alt="comment author avatar">
                                                        <%= comment.author.displayName %>
                                                    </a>
                                                </strong>
                                                
                                                <% if(comment.author.isMod) { %>
                                                    <div class="d-flex flex-row flex-grow-1 justify-content-end align-items-center"><i class="fas fa-crown text-warning mr-1"></i> <strong>Moderator</strong></div>
                                                <% } %>
                                            </div>
                                            
                                            <div class="d-flex flex-row flex-grow-1 justify-content-end"><em><%= moment(comment.createdAt).fromNow() %></em></div>
                                            
                                        </div>
                                        <div class="card-text comment-text"><%= comment.text %></div>
                                        <% if(currentUser && (comment.author._id.equals(currentUser._id) || currentUser.isAdmin)){ %>
                                            <hr>
                                            <div class="d-flex flew-row mt-2 justify-content-end align-items-center">
                                                <div class="mr-2">
                                                    <a  class="btn btn-sm btn-warning" 
                                                        href="/activities/<%= activity._id %>/comments/<%= comment._id %>/edit">
                                                        Edit
                                                    </a>
                                                </div>
                                                <div class="d-flex flew-row commentDeleteBtnDiv">
                                                    <div class="commentDeleteBtn">
                                                        <button class="btn btn-sm btn-danger">Delete</button>
                                                    </div>
                                                    <div class="commentDeleteCheck" style="display:none;">
                                                        <form class="inline-form" action="/activities/<%= activity._id %>/comments/<%= comment._id %>?_method=DELETE" method="POST">
                                                            <button class="btn btn-sm btn-danger">Please delete</button>
                                                        </form>
                                                        <button class="btn btn-sm btn-primary commentNoDeleteBtn">No, don't delete</button>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>
            <!-- COMMENT SECTION END -->
            
        </div>
    </div>
</div>


<!-- Move this script to it's own JS file in /public/ -->
<script>
  function initActivityShowMap() {
    var lat = <%= activity.lat %>;
    var lng = <%= activity.lng %>;
    var center = {lat: lat, lng: lng };
    var map = new google.maps.Map(document.getElementById('activity-show-map'), {
        zoom: 10,
        center: center,
        scrollwheel: false,
        mapTypeControl: false,
        streetViewControl: false,
        scaleControl: false,
        fullscreenControl: false
    });
    var marker = new google.maps.Marker({
        position: center,
        map: map
    });
  }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= process.env.MAPPING_API_KEY %>&callback=initActivityShowMap"></script>

<!-- Ajax script to increment counter on heart-->
<script>
    <% if(currentUser) { %>
        $('#sociableLove').on('click', function(){
            var ajaxRequestLove = $.get("<%= activity._id %>/<%= currentUser._id %>/love");
                                
            /* Process returned result */
            ajaxRequestLove.done(function( data ) {
                if(data) {
                    //add one to love, change color
                    $('#sociableLoveNum').text((parseInt($('#sociableLoveNum').text()) + 1));
                    $('#sociableLoveNum').removeClass("text-white")
                    $('#sociableLoveNum').addClass("text-dark")
                } else {
                    //remove one from love, change color
                    $('#sociableLoveNum').text((parseInt($('#sociableLoveNum').text()) - 1));
                    $('#sociableLoveNum').removeClass("text-dark")
                    $('#sociableLoveNum').addClass("text-white")
                }
            });
        });
    <% } else { %>
        $('#sociableLove').on('click', function(){
            window.location.href = "/login?return_url=" + window.location.pathname;
        });
    <% } %>
</script>

<!-- Script to change focus to comment input when add comment button is clicked -->
<script>
    $('#addCommentBtn').click(function(){
        setTimeout(function() {
            $('#addCommentInput').focus();
        }, 100);
    });
</script>

<!-- Script to track comment input length -->
<script>
    //if between 500 and 1000 show character count
    $('#addCommentInput').keyup(function(){
        var commentLength = $(this).val().length;
        
        if(commentLength > 1500 && commentLength < 2001) {
            $('#commentErrorDiv').html("Comment Length: " + commentLength + "/2000");
            $('#commentErrorDiv').removeClass("alert-danger");
            $('#commentErrorDiv').addClass("alert-warning");
            $('#postNewCommentBtn').prop('disabled', false);
        } else if(commentLength >= 2001) {
            //if over 2000 then disabled button (as this just needs to be browser side validation as the endpoint has additional validation)
            $('#commentErrorDiv').html("Comment Length: " + commentLength + "/2000");
            $('#commentErrorDiv').removeClass("alert-warning");
            $('#commentErrorDiv').addClass("alert-danger");
            $('#postNewCommentBtn').prop('disabled', true);
        } else {
            $('#commentErrorDiv').removeClass("alert-warning");
            $('#commentErrorDiv').removeClass("alert-danger");
            $('#commentErrorDiv').html("");
            $('#postNewCommentBtn').prop('disabled', false);
        }
    })
</script>


<!-- Script to show/hide check delete buttons -->
<script>
    //show confirmation buttons
    $('.commentDeleteBtnDiv').on('click', function(){
        $(this).children('.commentDeleteBtn').hide();
        $(this).children('.commentDeleteCheck').show();
        $(this).siblings().hide();
    });
    
    //hide confirmation buttons
    $('.commentNoDeleteBtn').on('click', function(){
        event.stopPropagation();
        $(this).parent().hide();
        $(this).parent().siblings().show();
        $(this).parent().parent().siblings().show();
    });
    
</script>

<!-- Script to scroll to comments section when comment bubble is clicked -->
<script>
    function scrollToComments() {
        event.preventDefault(); //Prevent default anchor click behavior
        var hash = "#commentSection";
        
        $('html, body').animate({
            scrollTop: $(hash).offset().top
        }, 800, function(){
            window.location.hash = hash;
        });
    }
</script>

<% include ../partials/footer %>